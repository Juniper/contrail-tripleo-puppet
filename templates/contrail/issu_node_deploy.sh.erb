# TODO: delete the script

#!/bin/bash -x

my_file="$(readlink -e "$0")"
my_dir="$(dirname $my_file)"

issu_env_file=${issu_env_file: "$my_dir/issu.env"}

if [ -f "$"issu_env_file ] ; then
  source $issu_env_file
fi

if [[ -z "$ansible_deployer_image" && ( -z "$container_registry" || -z "$container_tag" ) ]] ; then
   echo "check that container_tag and container_registry are not empty if ansible_deployer_image is empty"
   exit -1
fi

ansible_deployer_image=${ansible_deployer_image:-"${container_registry}/contrail-kolla-ansible-deployer:${container_tag}"}
host_home_dir=~
host_ssh_dir=${host_ssh_dir:-"$host_home_dir/.ssh"}
working_dir=${working_dir:-'/tmp/contrail_issu'}
instances_yaml=${instances_yaml:-'instances_issu.yaml'}

mkdir -p "$working_dir"

cp -f "$instances_yaml" "${working_dir}/instances.yaml"

cat << EOF > ${working_dir}/container_hosts.yml
ansible_python_interpreter: /opt/rh/python27/root/usr/bin/python2.7
contrail_ansible_environment:
  PATH: /opt/rh/python27/root/usr/bin:{{ lookup( 'env', 'PATH') }}
  LD_LIBRARY_PATH: /opt/rh/python27/root/usr/lib64
  PYTHONPATH: "{{ lookup( 'env', 'PYTHONPATH') }}:/usr/lib64/python2.7/site-packages"
EOF

cat << EOF > ${working_dir}/entrypoint.sh
#!/bin/bash -x
# FIXME:
# PyYAML 5.1 gets installed as a dependency to ansible or the oslo.config
# package, but this version has a bug that prevents proper rendering of
# lists when generating docker-compose files.
# Till it gets fixed, install specific version of PyYAML required for the
# install_contrail.yml playbook. Can be removed after its fixed upstream
pip install pyyaml==3.13
########################
mkdir -p ~/.ssh
chmod 700 ~/.ssh
cp $working_dir/ssh/* ~/.ssh/
chown -R root:root ~/.ssh
cd /root/contrail-ansible-deployer;
cp -f ${working_dir}/instances.yaml config/
mkdir -p inventory/group_vars
cp -f ${working_dir}/container_hosts.yml inventory/group_vars/container_hosts.yml
ansible-playbook -v -e orchestrator=openstack -i inventory/ playbooks/install_contrail.yml
EOF
chmod +x ${working_dir}/entrypoint.sh

sudo docker run --rm -it --network host --name issu_deploy \
  -v "$working_dir":"$working_dir" \
  -v "$host_ssh_dir":"$working_dir/ssh":ro \
  --entrypoint ${working_dir}/entrypoint.sh \
  $ansible_deployer_image

if [[ $? != 0 ]] ; then
  echo "ERROR: failed to run deploy issu Contrail Controller node"
  sudo contrail-status
  exit -1
fi

echo "ISSU node deployed successfully"
echo "Wait for 60 sec for Contrail is initializing..." 
sleep 60
echo "Contrail status:"
sudo contrail-status
