#!/bin/bash -x

container_registry=${container_registry:-<%= @container_registry %>}
container_tag=${container_tag:-<%= @container_tag %>}
ansible_deployer_image=${ansible_deployer_image:-"${container_registry}/contrail-kolla-ansible-deployer:${container_tag}"}

instances_yaml=${instances_yaml:-'instances_issu.yaml'}
working_dir=${working_dir:-'/tmp/contrail_issu'}
ssh_dir="$working_dir/ssh"

mkdir -p "$working_dir"
mkdir -p "$ssh_dir"

cp -f "$instances_yaml" "${working_dir}/instances.yaml"

cat << EOF > ${working_dir}/install_contrail_issu.yml
- hosts: all
  include: install_contrail.yml
  vars:
    ansible_python_interpreter: /opt/rh/python27/root/usr/bin/python2.7
  environment:
    PATH: /opt/rh/python27/root/usr/bin:{{ ansible_env.PATH | default() }}
    LD_LIBRARY_PATH: /opt/rh/python27/root/usr/lib64
    PYTHONPATH: "{{ lookup( 'env', 'PYTHONPATH') }}:/usr/lib64/python2.7/site-packages"
EOF

cat << EOF > ${working_dir}/entrypoint.sh
#!/bin/bash -x
mkdir -p ~/.ssh
chmod 700 ~/.ssh
cp ${ssh_dir}/* ~/.ssh/
chown -R root:root ~/.ssh
cd /root/contrail-ansible-deployer;
cp -f ${working_dir}/install_contrail_issu.yml playbooks/
cp -f ${working_dir}/instances.yaml config/
ansible-playbook --verbose -v -e orchestrator=openstack -i inventory/ playbooks/install_contrail_issu.yml
EOF

docker run --rm -it --network host \
  -v "$working_dir":"$working_dir" \
  --entrypoint ${working_dir}/entrypoint.sh \
  $ansible_deployer_image

if [[ $? != 0 ]] ; then
  echo "ERROR: failed to run deploy issu Contrail Controller node"
  exit -1
fi
